# RCN架构图解

## 整体架构流程

```
┌─────────────────────────────────────────────────────────────────┐
│                    输入: 多人运动序列                              │
│                   [B, P, T, D] + 轨迹 [B, P, T, J, K]            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      可变人数处理                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ num_persons = [2, 3, 4, 5]  # 每个batch的实际人数        │    │
│  │ mask = create_person_mask(num_persons, max_persons=5)   │    │
│  │ → [B, P] 掩码矩阵 (1=有效, 0=padding)                    │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   特征提取 (第三阶段优化)                          │
│  ┌──────────────────┐    ┌──────────────────┐                  │
│  │  标准方式         │ vs │  深度可分离卷积    │                  │
│  │  Linear(D→H)     │    │  Depthwise Conv  │                  │
│  │  参数: D×H       │    │  + Pointwise     │                  │
│  │                  │    │  参数: D×k + D×H │                  │
│  │                  │    │  节省: 8-10倍     │ ⭐推荐           │
│  └──────────────────┘    └──────────────────┘                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              关系编码 (层次化 - 第三阶段)                          │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 空间关系 (Spatial Relations)                         │       │
│  │  输入: positions, distances                          │       │
│  │  特征: [距离, 角度, 高度差]                           │       │
│  │  编码: MLP([feat_i, feat_j, spatial_geom])          │       │
│  └──────────────────────────────────────────────────────┘       │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 时序关系 (Temporal Relations)                        │       │
│  │  输入: velocities, accelerations                     │       │
│  │  特征: 运动模式, 速度趋势                             │       │
│  │  编码: MLP([velocity_i, velocity_j])                │       │
│  └──────────────────────────────────────────────────────┘       │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 交互关系 (Interactive Relations)                     │       │
│  │  输入: feature similarity                            │       │
│  │  特征: 行为相似性, 互补性                             │       │
│  │  编码: MLP([feat_i * feat_j, feat_i + feat_j])      │       │
│  └──────────────────────────────────────────────────────┘       │
│                              ↓                                   │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 可学习权重融合                                        │       │
│  │  weights = softmax([w_spatial, w_temporal, w_inter]) │       │
│  │  relation = Σ weights[i] * relation_i                │       │
│  │  压缩: Conv1d(3×D_rel → D_rel)                       │       │
│  └──────────────────────────────────────────────────────┘       │
│  输出: [B, P, P, D_rel] - 成对关系表示                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    注意力机制 (第二阶段)                           │
│  ┌───────────────────┐         ┌──────────────────┐             │
│  │ 标准多头注意力     │         │ 线性注意力        │             │
│  │ Q @ K^T @ V       │    vs   │ Q @ (K^T @ V)    │             │
│  │ O(P² × d)         │         │ O(P × d²)        │ ⭐多人场景   │
│  └───────────────────┘         └──────────────────┘             │
│                              ↓                                   │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 关系偏置注意力 (RelationBiasedAttention)             │       │
│  │  attn_scores = Q @ K^T / sqrt(d)                     │       │
│  │  relation_bias = MLP(relations)  # [B, H, P, P]     │       │
│  │  attn_scores += relation_bias                        │       │
│  │  output = softmax(attn_scores) @ V                   │       │
│  └──────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                 关系卷积层 (Multi-layer RCN)                      │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ Layer 1                                              │       │
│  │  ┌────────────┐    ┌────────────┐                   │       │
│  │  │ 节点自变换  │    │ 关系聚合    │                   │       │
│  │  │ h = FC(h)  │ +  │ Σ R[i,j]   │  → LayerNorm → ReLU│       │
│  │  └────────────┘    └────────────┘                   │       │
│  │              (残差连接)                               │       │
│  └──────────────────────────────────────────────────────┘       │
│                    ↓ (重复 num_layers 次)                        │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ Layer N                                              │       │
│  │  ... 同上 ...                                         │       │
│  └──────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     输出投影                                      │
│              Linear(hidden_dim → input_dim)                      │
│                  + 残差连接 (features + output)                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                输出: 增强的运动特征                                │
│                    [B, P, T, D]                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 三阶段对比

```
┌────────────────────────────────────────────────────────────────────────┐
│                          第一阶段: BasicRCN                             │
├────────────────────────────────────────────────────────────────────────┤
│ 特征提取: 标准Linear                                                     │
│ 关系编码: 基础三类型 (spatial, temporal, interactive)                    │
│ 聚合方式: RelationConvLayer                                             │
│ 注意力:   无                                                            │
│ 参数量:   ~0.8M                                                         │
│ 复杂度:   O(P² × T × D²)                                                │
│ 适用:     快速原型验证                                                   │
└────────────────────────────────────────────────────────────────────────┘
                              ↓ 增强
┌────────────────────────────────────────────────────────────────────────┐
│                       第二阶段: RCNWithAttention                        │
├────────────────────────────────────────────────────────────────────────┤
│ 特征提取: 标准Linear                                                     │
│ 关系编码: 基础三类型 + 关系偏置                                          │
│ 聚合方式: AttentionRCNLayer                                             │
│ 注意力:   多头注意力 + 自适应权重                                        │
│ 参数量:   ~1.5M                                                         │
│ 复杂度:   O(P² × T × D²) + O(P² × T × D)                               │
│ 适用:     需要注意力可视化                                               │
└────────────────────────────────────────────────────────────────────────┘
                              ↓ 优化
┌────────────────────────────────────────────────────────────────────────┐
│                       第三阶段: OptimizedRCN                            │
├────────────────────────────────────────────────────────────────────────┤
│ 特征提取: 深度可分离卷积 (节省8-10倍)                                    │
│ 关系编码: 层次化 (空间几何 + 时序模式 + 交互语义)                         │
│ 聚合方式: 优化的RCNLayer + 可学习权重                                    │
│ 注意力:   线性注意力 O(P×d²) (可选)                                      │
│ 参数量:   ~1.2M (轻量) / ~2.5M (标准)                                   │
│ 复杂度:   O(P × T × D²) ⭐ 最优                                         │
│ 适用:     生产环境部署 / 最佳性能                                        │
└────────────────────────────────────────────────────────────────────────┘
```

## 可变人数处理流程

```
输入场景: Batch中不同样本有不同人数

┌────────────────────────────────────────┐
│ Sample 0: 2人 [P0, P1, -, -, -]        │ B=4, max_P=5
│ Sample 1: 3人 [P0, P1, P2, -, -]       │
│ Sample 2: 4人 [P0, P1, P2, P3, -]      │
│ Sample 3: 5人 [P0, P1, P2, P3, P4]     │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│   创建掩码矩阵 mask: [B, P]             │
│   [[1, 1, 0, 0, 0],  # Sample 0        │
│    [1, 1, 1, 0, 0],  # Sample 1        │
│    [1, 1, 1, 1, 0],  # Sample 2        │
│    [1, 1, 1, 1, 1]]  # Sample 3        │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│  应用掩码到各个阶段                      │
│  1. 特征: features * mask[...,None,None]│
│  2. 关系: relations * mask_pair[...,None]│
│  3. 注意力: scores.masked_fill(~mask)   │
└────────────────────────────────────────┘
              ↓
┌────────────────────────────────────────┐
│ 输出: padding位置自动为0                 │
│ Sample 0: [out0, out1, 0, 0, 0]        │
│ Sample 1: [out0, out1, out2, 0, 0]     │
│ Sample 2: [out0, out1, out2, out3, 0]  │
│ Sample 3: [out0, ..., out4]            │
└────────────────────────────────────────┘
```

## 关系类型层次

```
                    Hierarchical Relation Types
                              │
        ┌─────────────────────┼─────────────────────┐
        ↓                     ↓                     ↓
   空间关系              时序关系              交互关系
   (Spatial)           (Temporal)          (Interactive)
        │                     │                     │
   ┌────┴────┐          ┌─────┴─────┐         ┌────┴────┐
   │         │          │           │         │         │
距离 角度 高度差      速度模式 运动趋势     相似性 互补性
   │         │          │           │         │         │
   ↓         ↓          ↓           ↓         ↓         ↓
  MLP      MLP        MLP         MLP       MLP       MLP
   │         │          │           │         │         │
   └────┬────┘          └─────┬─────┘         └────┬────┘
        ↓                     ↓                     ↓
    R_spatial             R_temporal           R_interactive
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              ↓
                    Learnable Weighting
                    weights = softmax([w1, w2, w3])
                              ↓
                    Weighted Fusion
              relation = Σ weights[i] × R[i]
                              ↓
                    1x1 Conv Compression
                  Final Relation: [B, P, P, D_rel]
```

## 参数量分解

```
OptimizedRCN (轻量版, ~1.2M)
┌─────────────────────────────────┐
│ 组件               参数量    占比  │
├─────────────────────────────────┤
│ 特征提取                         │
│  - Depthwise      39×3   ~0.1K │
│  - Pointwise      39×64  ~2.5K │
│                           (0.2%) │
├─────────────────────────────────┤
│ 关系编码器                       │
│  - Spatial MLP    ~50K          │
│  - Temporal MLP   ~50K          │
│  - Interactive    ~50K          │
│  - Fusion         ~20K          │
│                           (14%)  │
├─────────────────────────────────┤
│ RCN层 (3层)                     │
│  - Conv Layer     ~200K/层      │
│  - LayerNorm      ~1K/层        │
│  × 3层                    (50%)  │
├─────────────────────────────────┤
│ 注意力 (可选)                    │
│  - Q,K,V proj     ~40K          │
│  - Output proj    ~20K          │
│                           (5%)   │
├─────────────────────────────────┤
│ 其他                             │
│  - 输出投影        ~25K          │
│  - 其他参数        ~10K          │
│                           (3%)   │
└─────────────────────────────────┘
总计: ~1.2M 参数
```

## 复杂度对比

```
                  计算复杂度比较
                  (B=32, P=3, T=16, D=39)

操作          BasicRCN    WithAttention   OptimizedRCN
────────────────────────────────────────────────────
特征提取      O(PTD²)     O(PTD²)         O(PTD) ⭐
关系编码      O(P²D²)     O(P²D²)         O(P²D²)
注意力        -           O(TP²D)         O(TPD²) ⭐
RCN层         O(TP²D²)    O(TP²D²)        O(TPD²) ⭐
────────────────────────────────────────────────────
总复杂度      O(P²TD²)    O(P²TD²)        O(PTD²) ⭐

相对速度:     1.0×        0.8×            2.5× ⭐
```

## 使用决策流程

```
                    开始使用RCN
                         │
              ┌──────────┴──────────┐
              │ 是否需要快速验证?   │
              └──────────┬──────────┘
                   Yes ↓      ↓ No
              ┌──────────┐    │
              │BasicRCN  │    │
              │0.8M参数  │    │
              └──────────┘    │
                              │
              ┌───────────────┴────────────┐
              │ 是否需要注意力可视化?      │
              └───────────────┬────────────┘
                        Yes ↓      ↓ No
                   ┌──────────┐    │
                   │RCNWithAttn│   │
                   │1.5M参数   │   │
                   └──────────┘    │
                                   │
              ┌────────────────────┴───────────┐
              │ 是否资源受限/需要实时推理?     │
              └────────────────────┬───────────┘
                           Yes ↓        ↓ No
                   ┌──────────────┐  ┌──────────────┐
                   │OptimizedRCN  │  │OptimizedRCN  │
                   │(轻量)        │  │(标准)        │
                   │1.2M参数 ⭐   │  │2.5M参数      │
                   │推荐生产环境   │  │追求最佳性能   │
                   └──────────────┘  └──────────────┘
```

## 总结

**三阶段渐进式设计**:
- 第一阶段: 建立基础架构，快速验证
- 第二阶段: 增强注意力机制，提升性能
- 第三阶段: 全面优化，平衡效率和精度

**核心创新**:
- 动态掩码 → 支持可变人数
- 层次化关系 → 完整关系建模
- 深度可分离卷积 → 降低参数量
- 线性注意力 → 提高计算效率

**实用价值**:
- 参数可控 (0.8M - 2.5M)
- 易于集成 (三种方式)
- 完整文档 (四份文档)
- 模块化设计 (独立组件)
